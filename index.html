<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم تكا بليت</title>
    <style>
        body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; background-color: #f4f4f4; margin: 0; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1E5637; }
        textarea { width: 100%; height: 50vh; margin-top: 15px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px; direction: ltr; padding: 10px; }
        button { display: block; width: 100%; padding: 15px; margin-top: 15px; background-color: #C85A2B; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #a74b23; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .status { margin-top: 15px; padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; display: none; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>لوحة تحكم المنيو</h1>
        <p>قم بتعديل كود HTML الخاص بقائمة المنتجات أدناه. عند الحفظ، سيتم تحديث الموقع الرئيسي تلقائيًا.</p>
        <textarea id="menu-editor" placeholder="جاري تحميل كود المنيو..."></textarea>
        <button id="save-btn">حفظ ورفع التحديث</button>
        <div id="status" class="status"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('menu-editor');
            const saveBtn = document.getElementById('save-btn');
            const statusDiv = document.getElementById('status');
            
            let fullFileContent = ''; 
            
            // --- GitHub Repo Details (Corrected) ---
            const REPO_OWNER = 'Mahmoud-Walid1'; // Your correct GitHub username
            const REPO_NAME = 'Tikka_plate';   // Your correct repository name
            const FILE_PATH = 'index.html';
            const BRANCH_NAME = 'main';        // The branch name

            async function fetchMenu() {
                statusDiv.textContent = 'جاري تحميل آخر نسخة من المنيو...';
                statusDiv.style.display = 'block';
                statusDiv.className = 'status';

                try {
                    const response = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH_NAME}/${FILE_PATH}`);
                    if (!response.ok) throw new Error('فشل الاتصال بالريبو. تأكد من صحة البيانات وأن الريبو عام (Public).');
                    
                    fullFileContent = await response.text();
                    
                    const startMarker = '<div class="menu-grid">';
                    const endMarker = '</div>';
                    const startIndex = fullFileContent.indexOf(startMarker);
                    const endIndex = fullFileContent.lastIndexOf(endMarker);
                    
                    if (startIndex === -1 || endIndex === -1) throw new Error('لم يتم العثور على قسم المنيو في الملف.');
                    
                    const menuHTML = fullFileContent.substring(startIndex + startMarker.length, endIndex);
                    editor.value = menuHTML.trim();
                    statusDiv.textContent = 'تم التحميل. جاهز للتعديل.';
                    statusDiv.className = 'status success';

                } catch (error) {
                    editor.value = `خطأ: ${error.message}`;
                    statusDiv.textContent = 'فشل تحميل المنيو.';
                    statusDiv.className = 'status error';
                }
            }
            
            saveBtn.addEventListener('click', async () => {
                if (!confirm('هل أنت متأكد أنك تريد رفع هذه التعديلات على الموقع الرئيسي؟')) return;

                saveBtn.disabled = true;
                statusDiv.textContent = 'جاري الحفظ ورفع التحديث...';
                statusDiv.className = 'status';
                statusDiv.style.display = 'block';
                
                const newMenuHTML = editor.value;
                const startMarker = '<div class="menu-grid">';
                const endMarker = '</div>';
                const startIndex = fullFileContent.indexOf(startMarker);
                const endIndex = fullFileContent.lastIndexOf(endMarker);
                
                if (startIndex === -1 || endIndex === -1) {
                     statusDiv.textContent = 'خطأ في تكوين الملف الجديد.';
                     statusDiv.className = 'status error';
                     saveBtn.disabled = false;
                     return;
                }
                
                const newFullContent = fullFileContent.substring(0, startIndex + startMarker.length) + '\n' + newMenuHTML + '\n            ' + fullFileContent.substring(endIndex);

                try {
                    const response = await fetch('/api/update-menu', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newContent: newFullContent }),
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || !result.success) throw new Error(result.message || 'حدث خطأ غير معروف.');
                    
                    statusDiv.textContent = 'تم التحديث بنجاح! قد يستغرق الموقع دقيقة ليظهر التغيير.';
                    statusDiv.className = 'status success';
                    
                } catch (error) {
                    statusDiv.textContent = `فشل التحديث: ${error.message}`;
                    statusDiv.className = 'status error';
                } finally {
                    saveBtn.disabled = false;
                }
            });
            
            fetchMenu();
        });
    </script>
</body>
</html>
